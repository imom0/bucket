extends base

block title
  = block.super
  | 详情
  = object.pk
block content
  h2= object.name
  p= object.created_by.username
  p= object.description
  p= object.created_at|date

  div(ng-controller="CollectionController").ui.fluid.form.segment
    h3.ui.header
      请求
      - verbatim
        {{ location.protocol }}//{{ location.host }}{{ location.pathname }}{{ location.search }}
    div.field
      label
        地址:
      input(ng-model="base_url", maxlength=200, name="base_url", type="text")
    div.field
      label
        HTTP方法:
      div.grouped.inline.fields(ng-repeat="method in methods")
        div.field
          div.ui.radio.checkbox
            - verbatim
              <input type="radio" id="{{ idForMethod(method) }}" name="method" ng-model="method.selected">
              <label for="{{ idForMethod(method) }}">{{ method }}</label>
    div.field
      label
        HTTP头:
      div(ng-repeat="param in headers").three.fields
          div.field
            input(ng-model="param.name", type="text")
          div.field
            input(ng-model="param.value", type="text")
          div.field
            div.ui.red.icon.button
              i.icon.remove(ng-click="remove(headers, $index)")
      div.ui.blue.icon.button
        i.icon.add(ng-click="add(headers)")
    div.field
      label
        Query Params:
      div(ng-repeat="param in query").three.fields
          div.field
            input(ng-model="param.name", type="text")
          div.field
            input(ng-model="param.value", type="text")
          div.field
            div.ui.red.icon.button
              i.icon.remove(ng-click="remove(query, $index)")
      div.ui.blue.icon.button
        i.icon.add(ng-click="add(query)")
    div.field(ng-show="method == 'POST'")
      label
        | Body:
      textarea(name="body")
block javascript
  script
    function CollectionController($scope) {
      $scope.location = document.createElement('a');
      $scope.base_url = window.location;
      $scope.query = [{'name': '', 'value': ''}];
      $scope.headers = [{'name': '', 'value': ''}];
      $scope.methods = ['GET', 'POST', 'PUT'];

      $scope.add = function(list) {
        list.push({'name': '', 'value': ''});
      }

      $scope.remove = function(list, index) {
        list.splice(index, 1);
      }

      $scope.idForMethod = function(method) {
        return 'method-' + method;
      }

      $scope.$watch(
        function() {
          return $scope.base_url + JSON.stringify($scope.query);
        }, function () {
            var validParams = $scope.query.filter(function(i) {
              return !!i.name;
            });
            $scope.location.href = $scope.base_url;
            $scope.location.search = $.param(validParams);
        });
    }
