extends base

block title
  = block.super
  | 详情
  = object.pk
block content
  h2= object.name
  p= object.created_by.username
  p= object.description
  p= object.created_at|date

  div(ng-controller="CollectionController").ui.fluid.form.segment
    h3.ui.header
      请求
      - verbatim
        {{ location.protocol }}//{{ location.host }}{{ location.pathname }}{{ location.search }}
    div.field
      label
        地址:
      input(ng-model="base_url", maxlength=200, name="base_url", type="text")
    div.field
      label
        HTTP方法:
      div.grouped.inline.fields(ng-repeat="method in methods")
        div.field
          div.ui.radio.checkbox
            - verbatim
              <input type="radio" id="{{ idForMethod(method) }}" name="method" ng-model="methods.selected" ng-value="method">
              <label for="{{ idForMethod(method) }}">{{ method }}</label>
    div.field
      label
        HTTP头:
      div(ng-repeat="param in headers").three.fields
          div.field
            input(ng-model="param.name", type="text")
          div.field
            input(ng-model="param.value", type="text")
          div.field
            div.ui.red.icon.button(ng-click="remove(headers, $index)")
              i.icon.remove
      div.ui.blue.icon.button(ng-click="add(headers)")
        i.icon.add
    div.field
      label
        Query Params:
      div(ng-repeat="param in query").three.fields
          div.field
            input(ng-model="param.name", type="text")
          div.field
            input(ng-model="param.value", type="text")
          div.field
            div.ui.red.icon.button(ng-click="remove(query, $index)")
              i.icon.remove
      div.ui.blue.icon.button(ng-click="add(query)")
        i.icon.add
    div.field(ng-show="methods.selected == 'POST'")
      label
        | Body:
      textarea(name="body")
    div.ui.divider
    div.center.aligned.column
      div.right.floated.green.ui.labeled.icon.button(ng-click="updateRequests()")
        i.save.icon
        | 保存
block javascript
  script
    angular.module('myApp', ['ngCookies']).controller('CollectionController',
      ['$scope', '$http', '$cookies', function($scope, $http, $cookies) {
        $http.defaults.headers.post['X-CSRFToken'] = $cookies.csrftoken;
        $scope.location = document.createElement('a');
        $scope.base_url = window.location;
        $scope.query = [{'name': '', 'value': ''}];
        $scope.headers = [{'name': '', 'value': ''}];
        $scope.methods = ['GET', 'POST', 'PUT'];
        $scope.methods.selected = 'GET';
        $scope.requests = [];

        $scope.add = function(list) {
          list.push({'name': '', 'value': ''});
        }

        $scope.remove = function(list, index) {
          list.splice(index, 1);
        }

        $scope.idForMethod = function(method) {
          return 'method-' + method;
        }

        $scope.$watch(
          function() {
            return $scope.base_url + JSON.stringify($scope.query);
          }, function () {
              var validParams = $scope.query.filter(function(i) {
                return !!i.name;
              });
              $scope.location.href = $scope.base_url;
              $scope.location.search = $.param(validParams);
          });
        var fetchRequests = function() {
          $http({method: 'GET', url: "{% url 'collection_requests' object.id %}"})
          .success(function(data, status, headers, config) {
            if (data.meta.status == 'OK') {
              for (var i=0; i<data.data.length; i++) {
                var uri = data.data[i].uri,
                    location = document.createElement('a');
                location.href = uri;
                $scope.requests.push({
                  'location': location
                })
              }
            }
          })
          .error(function(data, status, headers, config) {
            alert('fail');
          })
        }

        $scope.updateRequests = function() {
          $http({method: 'POST', url: "{% url 'collection_requests' object.id %}"})
          .success(function(data, status, headers, config) {
            alert('update success');
          })
          .error(function(data, status, headers, config) {
            alert('update fail');
          })
        }

        fetchRequests();
      }
    ]);
